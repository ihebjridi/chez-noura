// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPER_ADMIN
  BUSINESS_ADMIN
  EMPLOYEE
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OrderStatus {
  CREATED
  LOCKED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
}

enum DailyMenuStatus {
  DRAFT
  PUBLISHED
  LOCKED
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  password   String? // Nullable for EMPLOYEE (email-based auth)
  role       UserRole
  businessId String?
  employeeId String?  @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business     Business?      @relation(fields: [businessId], references: [id])
  employee     Employee?      @relation(fields: [employeeId], references: [id])
  activityLogs ActivityLog[]

  @@index([email])
  @@index([businessId])
}

model Business {
  id        String       @id @default(uuid())
  name      String       @unique
  legalName String?
  email     String       @unique
  phone     String?
  address   String?
  logoUrl   String?
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  users           User[]
  employees       Employee[]
  orders          Order[]
  invoices        Invoice[]
  activityLogs    ActivityLog[]
  businessServices BusinessService[]

  @@index([email])
  @@index([name])
  @@index([status])
}

model Employee {
  id         String       @id @default(uuid())
  email      String       @unique
  firstName  String
  lastName   String
  businessId String
  status     EntityStatus @default(ACTIVE)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  business Business @relation(fields: [businessId], references: [id])
  user     User?
  orders   Order[]

  @@index([email])
  @@index([businessId])
}

model Meal {
  id            String       @id @default(uuid())
  name          String
  description   String?
  price         Decimal      @db.Decimal(10, 2)
  availableDate DateTime // Date when meal is available
  cutoffTime    DateTime // When ordering closes for this meal
  isActive      Boolean      @default(true)
  status        EntityStatus @default(ACTIVE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  orderItems OrderItem[]

  @@index([availableDate])
  @@index([cutoffTime])
  @@index([isActive])
}

model Pack {
  id        String   @id @default(uuid())
  name      String   @unique
  price     Decimal  @db.Decimal(10, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packComponents      PackComponent[]
  orders              Order[]
  dailyMenuPacks      DailyMenuPack[]
  servicePack         ServicePack?
  businessServicePacks BusinessServicePack[]
  businessServicePacksNextPack BusinessServicePack[] @relation("BusinessServicePackNextPack")

  @@index([isActive])
  @@index([name])
}

model Component {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packComponents PackComponent[]
  variants       Variant[]
  orderItems     OrderItem[]
}

model PackComponent {
  id          String   @id @default(uuid())
  packId      String
  componentId String
  required    Boolean  @default(true)
  orderIndex  Int // Order in which components appear in the pack
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  pack      Pack      @relation(fields: [packId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([packId, componentId])
  @@index([packId])
  @@index([componentId])
}

model Variant {
  id            String   @id @default(uuid())
  componentId   String
  name          String
  stockQuantity Int      @default(0)
  imageUrl      String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  component        Component          @relation(fields: [componentId], references: [id], onDelete: Cascade)
  orderItems       OrderItem[]
  dailyMenuVariants DailyMenuVariant[]
  dailyMenuServiceVariants DailyMenuServiceVariant[]

  @@unique([componentId, name])
  @@index([componentId])
  @@index([stockQuantity])
  @@index([isActive])
}

model DailyMenu {
  id          String          @id @default(uuid())
  date        DateTime        @unique // Date (YYYY-MM-DD)
  status      DailyMenuStatus @default(DRAFT)
  cutoffHour  String?         // Cutoff hour in HH:MM format (e.g., "14:00")
  publishedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  packs    DailyMenuPack[]
  variants DailyMenuVariant[]
  services DailyMenuService[]
  orders   Order[]

  @@index([date])
  @@index([status])
}

model DailyMenuPack {
  id          String   @id @default(uuid())
  dailyMenuId String
  packId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dailyMenu DailyMenu @relation(fields: [dailyMenuId], references: [id], onDelete: Cascade)
  pack      Pack      @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@unique([dailyMenuId, packId])
  @@index([dailyMenuId])
  @@index([packId])
}

model DailyMenuVariant {
  id           String   @id @default(uuid())
  dailyMenuId  String
  variantId    String
  initialStock Int      @default(50)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dailyMenu DailyMenu @relation(fields: [dailyMenuId], references: [id], onDelete: Cascade)
  variant   Variant   @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([dailyMenuId, variantId])
  @@index([dailyMenuId])
  @@index([variantId])
}

model Order {
  id          String      @id @default(uuid())
  employeeId  String
  businessId  String
  packId      String
  dailyMenuId String
  orderDate   DateTime // Date the order is for (YYYY-MM-DD)
  status      OrderStatus @default(CREATED)
  totalAmount Decimal     @db.Decimal(10, 2)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  employee  Employee   @relation(fields: [employeeId], references: [id])
  business  Business   @relation(fields: [businessId], references: [id])
  pack      Pack       @relation(fields: [packId], references: [id])
  dailyMenu DailyMenu  @relation(fields: [dailyMenuId], references: [id])
  items     OrderItem[]

  // Prevent duplicate orders per employee per day
  @@unique([employeeId, orderDate])
  @@index([employeeId])
  @@index([businessId])
  @@index([packId])
  @@index([dailyMenuId])
  @@index([orderDate])
  @@index([status])
  // Composite index for date-based queries with status filter (for aggregation)
  @@index([orderDate, status])
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  componentId String
  variantId   String
  createdAt   DateTime @default(now())

  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id])
  variant   Variant   @relation(fields: [variantId], references: [id])
  meal      Meal?     @relation(fields: [mealId], references: [id])
  mealId    String?

  @@unique([orderId, componentId]) // One variant per component per order
  @@index([orderId])
  @@index([componentId])
  @@index([variantId])
}

model Invoice {
  id            String        @id @default(uuid())
  businessId    String
  serviceId     String?       // Service this invoice is for (null for legacy invoices)
  invoiceNumber String        @unique
  periodStart   DateTime
  periodEnd     DateTime
  status        InvoiceStatus @default(DRAFT)
  subtotal      Decimal       @db.Decimal(10, 2)
  tax           Decimal?      @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  dueDate       DateTime
  issuedAt      DateTime?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  business Business      @relation(fields: [businessId], references: [id])
  service  Service?      @relation(fields: [serviceId], references: [id])
  items    InvoiceItem[]

  @@index([businessId])
  @@index([serviceId])
  @@index([businessId, serviceId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([businessId, periodStart, periodEnd])
  @@index([businessId, serviceId, periodStart, periodEnd])
}

model InvoiceItem {
  id            String   @id @default(uuid())
  invoiceId     String
  orderId       String   @unique // An order can belong to only one invoice
  orderDate     DateTime
  packName      String   // Pack name for this order
  quantity      Int      @default(1) // Always 1 (one pack per order)
  unitPrice     Decimal  @db.Decimal(10, 2) // Pack price
  totalPrice    Decimal  @db.Decimal(10, 2) // Pack price Ã— quantity
  createdAt     DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([orderId])
}

model DayLock {
  id        String   @id @default(uuid())
  lockDate  DateTime @unique // Date that was locked (YYYY-MM-DD)
  lockedAt  DateTime @default(now())
  lockedBy  String? // User ID who locked it (optional)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lockDate])
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String? // User who performed the action (optional for system actions)
  businessId String? // Business associated with the action
  action    String   // Action type (e.g., 'LOGIN', 'PASSWORD_RESET', 'BUSINESS_CREATED', etc.)
  details   String? // Additional details in JSON format
  ipAddress String? // IP address of the user
  userAgent String? // User agent string
  createdAt DateTime @default(now())

  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  business Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([businessId])
  @@index([action])
  @@index([createdAt])
  @@index([businessId, createdAt])
}

model Service {
  id             String   @id @default(uuid())
  name           String   @unique
  description    String?
  isActive       Boolean  @default(true)
  isPublished    Boolean  @default(false)
  orderStartTime String?  // Time in HH:MM format when orders start being accepted each day
  cutoffTime     String?  // Time in HH:MM format when orders stop being accepted each day
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  servicePacks    ServicePack[]
  businessServices BusinessService[]
  invoices        Invoice[]
  dailyMenuServices DailyMenuService[]

  @@index([name])
  @@index([isActive])
  @@index([isPublished])
}

model ServicePack {
  id        String   @id @default(uuid())
  serviceId String
  packId    String   @unique // Each pack belongs to exactly one service
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  pack    Pack    @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([packId])
}

model BusinessService {
  id        String   @id @default(uuid())
  businessId String
  serviceId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  businessServicePacks BusinessServicePack[]

  @@unique([businessId, serviceId])
  @@index([businessId])
  @@index([serviceId])
  @@index([isActive])
}

model BusinessServicePack {
  id              String   @id @default(uuid())
  businessServiceId String
  packId          String
  isActive        Boolean  @default(true)
  nextPackId      String?  // Pack that will be active starting from effectiveDate
  effectiveDate   DateTime? // Date when nextPackId takes effect (next service day)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  businessService BusinessService @relation(fields: [businessServiceId], references: [id], onDelete: Cascade)
  pack            Pack            @relation(fields: [packId], references: [id], onDelete: Cascade)
  nextPack        Pack?           @relation("BusinessServicePackNextPack", fields: [nextPackId], references: [id], onDelete: SetNull)

  @@unique([businessServiceId, packId])
  @@index([businessServiceId])
  @@index([packId])
  @@index([isActive])
  @@index([effectiveDate])
}

model DailyMenuService {
  id          String   @id @default(uuid())
  dailyMenuId String
  serviceId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dailyMenu DailyMenu @relation(fields: [dailyMenuId], references: [id], onDelete: Cascade)
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  variants  DailyMenuServiceVariant[]

  @@unique([dailyMenuId, serviceId])
  @@index([dailyMenuId])
  @@index([serviceId])
}

model DailyMenuServiceVariant {
  id                String   @id @default(uuid())
  dailyMenuServiceId String
  variantId         String
  initialStock      Int      @default(50)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  dailyMenuService DailyMenuService @relation(fields: [dailyMenuServiceId], references: [id], onDelete: Cascade)
  variant          Variant          @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([dailyMenuServiceId, variantId])
  @@index([dailyMenuServiceId])
  @@index([variantId])
}
